---
title: "Report on gender wage gap in legal jobs"
author: 'Endes-Nagy PÃ©ter'
output: 
  pdf_document:
    extra_dependencies: ["float"]
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")
# Set graph size
#knitr::opts_chunk$set(echo = FALSE, out.width = "50%" )#fig.asp = 0.5, fig.width = 7, out.width = "90%" )

rm(list=ls())

library(tidyverse)
library(fixest)
library(modelsummary)
library(estimatr)
library(lspline)
library(kableExtra)

#import full dataset
df <- read_csv('https://osf.io/4ay9x/download', 
               col_types = cols(.default = "?", 
                                state = "c"))

##CLEANING and FILTERING
#differentiate between higher level (1) and supporting jobs (0) in the legal field
df <- df %>% 
  mutate( occ = ifelse( occ2012 == 2100 , 1 , 
                           ifelse( df$occ2012 >= 2105 & df$occ2012 <= 2160 , 0 , 999 ) ) )

#filter out other occupations (999) and level of education below Bachelor's degree
df <- df %>% 
  filter( occ == 1 | occ == 0 ) %>% 
  filter( grade92 >= 43 )

#generate variables for female, log wage and education
df <- df %>% mutate( female = as.numeric( sex == 2 ) ) %>%
  mutate( w = earnwke/uhours ) %>%
  mutate( lnw = log( w ) ) %>% 
  mutate( BA_degree = ifelse( grade92 == 43 , 1 , 0 ) ) %>% 
  mutate( MA_degree = ifelse( grade92 == 44 , 1 , 0 ) ) %>% 
  mutate( Prof_degree = ifelse( grade92 == 45 , 1 , 0 ) ) %>% 
  mutate( PhD_degree = ifelse( grade92 == 46 , 1 , 0 ) )

#additional functions for descriptive statistics
P95 <- function(x){quantile(x,0.95,na.rm=T)}
P05 <- function(x){quantile(x,0.05,na.rm=T)}
Range <- function(x){max(x,na.rm=T)-min(x,na.rm=T)}

```

## Introduction

This is a report on *gender wage gap in legal jobs*. 

HERE COMES THE MOTIVATION WHY THIS IS A MEANINGFUL PROJECT AND WHAT IS THE MAIN GOAL!

For more details on the project see: <http://www.thebillionpricesproject.com/>.

## Data



HERE COMES A DETAILLED EXPLANATION ABOUT WHERE THE DATA COMES FROM AND IF IT IS REPRESENTATIVE OR NOT.

Our main interest is whether online prices are lower or higher than simple retail store prices. We investigated the data on the collected prices and we have the following descriptive statistics on online, in-store prices and in their differences.

```{r descriptives, echo=FALSE}
datasummary( (`wage` = w) + (`ln(wage)` = lnw) + age ~ 
               Mean + SD + Median + Min + Max + Range + P05 + P95 + N , 
             data = df , 
             title = 'Descriptive statstics of hourly wages and age' , 
             notes = 'data from: https://osf.io/4ay9x') %>% 
  kableExtra::kable_styling(latex_options = "hold_position")
```

The number of observations is `r length(df$age)` for all of our key variables.

DESCRIPTION OF THE SUMMARY STATS: WHAT CAN WE LEARN FROM THEM?

As the focus is the price difference, the next Figure shows the histogram for this variable.

```{r, echo=FALSE, warning=FALSE, fig.width=4, fig.height = 3, fig.align="center" }

#let's have a look on conditional distribution of wage by sex
ggplot( data = df , aes( x = female, y = w )) +
  geom_violin(aes (group = female ) , trim = F) + 
  geom_boxplot(aes (group = female ) , width = 0.1) +
  scale_x_continuous(label = c('male','female') , breaks = c(0,1)) +
  scale_y_continuous( limits = c(0,150)) +
  labs( x = '' , 
        y = 'Hourly wage (USD)' ,
        title = 'Hourly wages in legal jobs, by sex' ,
        caption = 'data from: https://osf.io/4ay9x') +
  stat_summary(fun = mean, geom = 'point') +
  theme(
    panel.background = element_rect( fill = 'white' ) ,
    panel.grid.major = element_line( size = 0.1, linetype = 'solid',
                                     colour = 'azure3') ,
    panel.grid.minor = element_line( size = 0.1, linetype = 'dotted',
                                     colour = 'azure4') ,
    plot.subtitle = element_text( size = 10 ) )

```


```{r, echo=FALSE, warning=FALSE, fig.width=4, fig.height = 3, fig.align="center" }

#check relationship between age and lnw see if linear
ggplot( data = df , aes( x = age, y = lnw )) +
  geom_point(  size = .75, shape = 16, ) + 
  geom_smooth( method = 'loess', formula = y ~ x , size = .5) +
  labs( x = 'Age' , 
        y = 'ln(Hourly wage (USD))' ,
        title = 'Hourly log wages in legal jobs, by age' ,
        caption = 'data from: https://osf.io/4ay9x') +
  scale_x_continuous(breaks = seq(15,65,by=5)) +
  theme(
    panel.background = element_rect( fill = 'white' ) ,
    panel.grid.major = element_line( size = 0.1, linetype = 'solid',
                                     colour = 'azure3') ,
    panel.grid.minor = element_line( size = 0.1, linetype = 'dotted',
                                     colour = 'azure4') ,
    plot.subtitle = element_text( size = 10 ) )

```


DESCRIPTION OF THE FIGURE. WHAT DOES IT TELS US?

(May change the order of descriptive stats and graph.)

## Testing Price Differences


```{r, echo = FALSE }
#REGRESSION MODELS
#simple
reg1 <- lm(lnw ~ female, data = df)

#with occupation type (cool VS supporting jobs)
reg2 <- lm(lnw ~ occ + female , data = df)

# add level of education. Bachelor's degree is the reference
reg3 <- lm(lnw ~ occ + female +  MA_degree + Prof_degree + PhD_degree , data = df)

#add age with lspline, 35 looked like a decent point on the above graph
reg4 <- lm(lnw ~ occ + female + MA_degree + Prof_degree + PhD_degree + lspline( age , 35), data = df)

msummary( list( reg1 , reg2 , reg3 , reg4 ) ,
         fmt = "%.4f",
         gof_omit = 'DF|Deviance|Log.Lik.|F|R2 Adj.|AIC|BIC|Num.Obs.',
         stars = c('*' = .05, '**' = .01) ,
         caption = 'Modelling wage gap' ) %>% 
  kableExtra::kable_styling(latex_options = "hold_position")

```

We test the hypothesis, whether the price difference is zero, therefore there is no difference between retail and online prices:


$$H_A:=\text{price online} - \text{price retail} \neq 0$$



## Robustness check / 'Heterogeneity analysis'

Task: calculate and report t-tests for each countries. 

You should report: Country, mean of p_diff, se of the mean for p_diff, number of observations in each country, t-statistic, p-value.

Hint: use 'kable()' and to hold the table position you can define the following argument: 'position = "H"' . Take care of caption, number of digits you use and the name of variables you report! You may check how the output changes if you use 'booktabs = TRUE' input for kable!

```{r, echo=FALSE, warning=FALSE, fig.width=4, fig.height = 3, fig.align="center" }

#saving predicted values
df$lnw_hat1 <- predict(reg1)
df$lnw_hat2 <- predict(reg2)
df$lnw_hat3 <- predict(reg3)
df$lnw_hat4 <- predict(reg4)

#calculating residuals
df$lnw_res1 <- df$lnw - df$lnw_hat1
df$lnw_res2 <- df$lnw - df$lnw_hat2
df$lnw_res3 <- df$lnw - df$lnw_hat3
df$lnw_res4 <- df$lnw - df$lnw_hat4


#plotting residuals and predicted values
ggplot(df, aes( x = lnw_hat4 , y = lnw_res4 ) ) + 
  geom_point( size = 0.2 ) +
  geom_smooth( method="lm", colour='blue', se=F , formula = y~x , size = .5) +
  labs( caption = 'data from: https://osf.io/4ay9x' ,
        x = 'ln(Predicted hourly wage)' , 
        y = 'Residual', 
        title = 'Fitness of Model 4' , 
        subtitle = 'Residuals; ln(hourly wage) prediction based on sex, occupation, education and age ') +
  theme(
    panel.background = element_rect( fill = 'white' ) ,
    panel.grid.major = element_line( size = 0.1, linetype = 'solid',
                                     colour = 'azure3') ,
    panel.grid.minor = element_line( size = 0.1, linetype = 'dotted',
                                     colour = 'azure4') ,
    plot.subtitle = element_text( size = 10 )
  )


```

Extra: In words, select those countries, where you can not reject the alternative that the prices are different. With the command '\textcolor{red}{this is red} you can highlight these countries!



## Conclusion

HERE COMES WHAT WE HAVE LEARNED AND WHAT WOULD STRENGHTEN AND WEAKEN OUR ANALYSIS.
